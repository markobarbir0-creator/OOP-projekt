#include <SFML/Graphics.hpp>
#include <vector>
#include <iostream>
#include <cstdlib>
using namespace std;
using namespace sf;

const float CELL_WIDTH = 800.0f / 7;
const float CELL_HEIGHT = 700.0f / 6;
const float PADDING = 10.f;

class Player {
public:
    int id;
    string name;
    Player(int i = 0) : id(i) {}
};

class Board {
private:
    vector<vector<int>> grid;
    RectangleShape Boardshape;
public:
    const int rows = 6;
    const int columns = 7;
    Board() {
        grid.resize(rows, vector<int> (columns,0));
        Boardshape.setSize(Vector2f(800.f, 700.f));
        Boardshape.setFillColor(Color::Blue);
    }
    void draw(RenderWindow& window) {
        window.draw(Boardshape);
        for (auto i = 0; i < rows; i++) {
            for (auto j = 0; j < columns; j++) {
                CircleShape krug(45.f);
                float X = j * CELL_WIDTH + PADDING;
                float Y = i * CELL_HEIGHT + PADDING;
                krug.setPosition(X, Y);
                if (grid[i][j] == 0) {
                    krug.setFillColor(Color::White);
                    window.draw(krug);
                }
                else if (grid[i][j] == 1) {
                    krug.setFillColor(Color::Yellow);
                    window.draw(krug);
                }
                else if (grid[i][j] == 2) {
                    krug.setFillColor(Color::Red);
                    window.draw(krug);
                }

            }
        }

    }
    bool jelipun(int stupac) {
        return grid[0][stupac] != 0;
    }
    bool dodajzeton(int stupac, int igrac,int &red) {

        if (stupac < 0 || stupac >= columns) {
            return false;
        }
        for (int i = rows - 1; i >= 0; i--) {
            if (grid[i][stupac] == 0) {
                grid[i][stupac] = igrac;
                red = i;
                return true;
            }
        }
        return false;
    }
    bool pronadired(int stupac, int &red) {
        for (int i = rows - 1; i >= 0; i--) {
            if (grid[i][stupac] == 0) {
                red = i;
                return true;
            }
        }
        return false;
    }
    bool provjerapobjede(int igrac,int stupac,int red) {
        int brojac = 0;
        for (int i = rows - 1; i >= 0; i--) { 
            if (grid[i][stupac] == igrac) {
                brojac++;
                if (brojac == 4) {
                    return true;
                }
            }
            else {
                brojac = 0;
            }    
        }
        brojac = 0;
        for (int j = 0; j <columns; j++) {
            if (grid[red][j] == igrac) {
                brojac++;
                if (brojac == 4) {
                    return true;
                }
            }
            else {
                brojac = 0;
            }
        }
        for (int i = 0; i <= rows - 4; i++) {
            for (int j = 0; j <= columns - 4; j++) {
                int brojacgd = 0;
                for (int k = 0; k < 4; k++) {
                    if (grid[i + k][j + k] == igrac) brojacgd++;
                    else break;
                }
                if (brojacgd == 4) return true;
            }
        }
        for (int i = 0; i <= rows - 4; i++) {
            for (int j = 3; j < columns; j++) {
                int brojacdg = 0;
                for (int k = 0; k < 4; k++) {
                    if (grid[i + k][j - k] == igrac) brojacdg++;
                    else break;
                }
                if (brojacdg == 4) return true;
            }
        }

        return false;
    }
    void postavizeton(int red, int stupac, int igrac) {
        grid[red][stupac] = igrac;
    }


};

class Game{
private:
    Board board;
    Player p1, p2;
    int currentplayer;
    int stupac;
    int red;
    int igrac;
    bool pada;
    int animstupac;
    int animred;
    float animY;
    int animigrac;
    float brzina = CELL_HEIGHT / (0.5 * 60);//cellh/(vrijemepada u sekundama*fps)

public:
    Game(){
        p1.id = 1;
        p2.id = 2;
        cout << "Unesi ime igraca 1: ";
        cin >> p1.name;
        cout << "Unesi ime igraca 2: ";
        cin >> p2.name;
        currentplayer = rand() % 2 + 1;
        cout << "Na redu je: " << trenutniigrac() << endl;
    }
    string trenutniigrac() {
        return (currentplayer == 1) ? p1.name : p2.name;
    }
    int getcurrentplayer() {
        return currentplayer;
    }
    Board& getboard() {
        return board;
    }

    
    
    void handleclick(int x) {
         stupac = x / CELL_WIDTH;
        if ((stupac >= 0) && (stupac < 7)) {
            if ((!board.jelipun(stupac))&&(!pada)) {
                board.pronadired(stupac, red);
                pada = true;
                animstupac = stupac;
                animred = red;
                animigrac = currentplayer;
                animY = 0;
                
            }
        }
    }
    void update() {
        int ciljaniY = animred * CELL_HEIGHT + PADDING;
        if (pada) {
            if (animY < ciljaniY) {
                animY += brzina;
            }
            else {
                animY = ciljaniY;
                board.postavizeton(animred, animstupac, animigrac);
                pada = false;
                if (board.provjerapobjede(animigrac, animstupac, animred)) {
                    cout << "Pobijedio je: " 
                         << ((animigrac == 1) ? p1.name : p2.name) << endl;
                }
                else {
                    currentplayer = (currentplayer == 1) ? 2 : 1;
                    cout << "Na redu je: " << trenutniigrac() << endl;
                }
                
            }
        }
    }
    void gamedraw(RenderWindow& w) {
        if (pada) {
            CircleShape animkrug(45.f);
            float X = animstupac * CELL_WIDTH + PADDING;
            float Y = animY;
            animkrug.setPosition(X, Y);
            if (animigrac == 1) {
                animkrug.setFillColor(Color::Yellow);
            }
            else if (animigrac == 2) {
                animkrug.setFillColor(Color::Red);
            }
            w.draw(animkrug);
        }
    }

};

int main() {
    RenderWindow window(VideoMode(800, 700), "Connect Four - Faza 1");
    window.setFramerateLimit(60);


    Board board;
    Game game;
    
    

    while (window.isOpen()) {
        Event event;
        while (window.pollEvent(event)) {
            if (event.type == Event::Closed)
                window.close();
            if (event.type == Event::MouseButtonPressed)
                game.handleclick(event.mouseButton.x);
        }
        game.update();
        window.clear(Color::White);
        game.getboard().draw(window);
        game.gamedraw(window);
       
       
        window.display();

    }
    
   

    return 0;
}
