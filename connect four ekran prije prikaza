#include <SFML/Graphics.hpp>
#include <vector>
#include <iostream>
#include <cstdlib>
#include <ctime>

using namespace std;
using namespace sf;

const float CELL_WIDTH = 800.0f / 7;
const float CELL_HEIGHT = 700.0f / 6;
const float PADDING = 10.f;

class Player {
public:
    int id;
    string name;
    Player(int i = 0) : id(i) {}
};

class Board {
private:
    vector<vector<int>> grid;
    RectangleShape Boardshape;
public:
    const int rows = 6;
    const int columns = 7;

    Board() {
        grid.resize(rows, vector<int>(columns, 0));
        Boardshape.setSize(Vector2f(800.f, 700.f));
        Boardshape.setFillColor(Color::Blue);
    }

    void draw(RenderWindow& window) {
        window.draw(Boardshape);
        for (int i = 0; i < rows; i++) {
            for (int j = 0; j < columns; j++) {
                CircleShape krug(45.f);
                krug.setPosition(j * CELL_WIDTH + PADDING, i * CELL_HEIGHT + PADDING);

                if (grid[i][j] == 0) krug.setFillColor(Color::White);
                else if (grid[i][j] == 1) krug.setFillColor(Color::Yellow);
                else krug.setFillColor(Color::Red);

                window.draw(krug);
            }
        }
    }

    bool jelipun(int stupac) {
        return grid[0][stupac] != 0;
    }

    bool pronadired(int stupac, int& red) {
        for (int i = rows - 1; i >= 0; i--) {
            if (grid[i][stupac] == 0) {
                red = i;
                return true;
            }
        }
        return false;
    }

    bool provjerapobjede(int igrac, int stupac, int red) {
        int brojac = 0;

        for (int i = 0; i < rows; i++) {
            brojac = (grid[i][stupac] == igrac) ? brojac + 1 : 0;
            if (brojac == 4) return true;
        }

        brojac = 0;
        for (int j = 0; j < columns; j++) {
            brojac = (grid[red][j] == igrac) ? brojac + 1 : 0;
            if (brojac == 4) return true;
        }

        for (int i = 0; i <= rows - 4; i++)
            for (int j = 0; j <= columns - 4; j++)
                if (grid[i][j] == igrac && grid[i + 1][j + 1] == igrac &&
                    grid[i + 2][j + 2] == igrac && grid[i + 3][j + 3] == igrac)
                    return true;

        for (int i = 0; i <= rows - 4; i++)
            for (int j = 3; j < columns; j++)
                if (grid[i][j] == igrac && grid[i + 1][j - 1] == igrac &&
                    grid[i + 2][j - 2] == igrac && grid[i + 3][j - 3] == igrac)
                    return true;

        return false;
    }

    void postavizeton(int red, int stupac, int igrac) {
        grid[red][stupac] = igrac;
    }

    void uklonizeton(int red, int stupac) { // NOVO
        grid[red][stupac] = 0;              // NOVO
    }                                       // NOVO

    void reset() {
        for (int i = 0; i < rows; i++)
            for (int j = 0; j < columns; j++)
                grid[i][j] = 0;
    }
};

enum StanjeIgre {
    izbornik,
    DvaIgraca,
    JedanIgrac,
    Menu,
    Exit,
    Restart
};

class Game {
private:
    Board board;
    Player p1, p2;
    int currentplayer;
    int stupac, red;
    bool pada = false;
    int animstupac, animred, animigrac;
    float animY;
    float brzina = CELL_HEIGHT / (0.5f * 60);
    bool igragotova = false;
    int pobjednik;
    bool prikazprvog = false;

    StanjeIgre stanjeIgre;

    RectangleShape gumbDvaIgraca;
    RectangleShape gumbRacunalo;
    RectangleShape gumbExit;
    RectangleShape gumbRestart;
    Font font;
    Text naslov, tekstDvaIgraca, tekstRacunalo, tekstPobjede, tekstPrvi;
    Clock prvi;
    Text tekstRestart, tekstExit;

    bool mozePobjedit(int igrac, int stupac) { // NOVO-----------------------------------------------
        int r;
        if (!board.pronadired(stupac, r)) return false;
        board.postavizeton(r, stupac, igrac);
        bool win = board.provjerapobjede(igrac, stupac, r);
        board.uklonizeton(r, stupac);
        return win;
    }

    int odaberiNajboljiStupacAI() { // NOVO----------------------------------------------------------
        for (int s = 0; s < 7; s++)
            if (!board.jelipun(s) && mozePobjedit(2, s))
                return s;

        for (int s = 0; s < 7; s++)
            if (!board.jelipun(s) && mozePobjedit(1, s))
                return s;

        int s;
        do { s = rand() % 7; } while (board.jelipun(s));
        return s;
    }

public:
    Game() {
        srand(time(nullptr));
        stanjeIgre = izbornik;

        p1.id = 1;
        p2.id = 2;
        currentplayer = rand() % 2 + 1;

        font.loadFromFile("C:/Windows/Fonts/arial.ttf");

        naslov.setFont(font);
        naslov.setString("CONNECT 4");
        naslov.setCharacterSize(60);
        naslov.setPosition(200, 100);

        gumbDvaIgraca.setSize(Vector2f(450, 80));
        gumbDvaIgraca.setPosition(150, 250);
        gumbDvaIgraca.setFillColor(Color::Green);

        gumbRacunalo.setSize(Vector2f(450, 80));
        gumbRacunalo.setPosition(150, 360);
        gumbRacunalo.setFillColor(Color::Red);

        gumbExit.setSize(Vector2f(450, 80));
        gumbExit.setPosition(150, 250);
        gumbExit.setFillColor(Color::Green);

        gumbRestart.setSize(Vector2f(450, 80));
        gumbRestart.setPosition(150, 360);
        gumbRestart.setFillColor(Color::Red);

        tekstDvaIgraca.setFont(font);
        tekstDvaIgraca.setString("PLAYER VS PLAYER");
        tekstDvaIgraca.setCharacterSize(40);
        tekstDvaIgraca.setPosition(180, 265);

        tekstRacunalo.setFont(font);
        tekstRacunalo.setString("PLAYER VS BOT");
        tekstRacunalo.setCharacterSize(40);
        tekstRacunalo.setPosition(180, 375);

        tekstRestart.setFont(font);
        tekstRestart.setString("RESTART");
        tekstRestart.setCharacterSize(40);
        tekstRestart.setPosition(180, 375);

        tekstExit.setFont(font);
        tekstExit.setString("EXIT");
        tekstExit.setCharacterSize(40);
        tekstExit.setPosition(180, 265);

        tekstPobjede.setFont(font);
        tekstPobjede.setCharacterSize(50);
        tekstPobjede.setPosition(200, 100);

        tekstPrvi.setFont(font);
        tekstPrvi.setCharacterSize(60);
        tekstPrvi.setPosition(180, 350);
    }

    bool jeIzbornik() { return stanjeIgre == izbornik; }
    bool jeMenu() { return stanjeIgre == Menu; }
    bool jeIgraGotova() { return igragotova; }
    StanjeIgre getStanje() { return stanjeIgre; }
    void setStanje(StanjeIgre s) { stanjeIgre = s; }

    Board& getboard() { return board; }

    void obradiKlikEnd(Vector2i mis) {
        if (gumbRestart.getGlobalBounds().contains(mis.x, mis.y)) {
            stanjeIgre = Restart;
        }
        else if (gumbExit.getGlobalBounds().contains(mis.x, mis.y)) {
            stanjeIgre = Exit;
        }
    }

    void obradiKlikIzbornika(Vector2i mis) {
        if (gumbDvaIgraca.getGlobalBounds().contains(mis.x, mis.y)) {
            stanjeIgre = DvaIgraca;
            cin >> p1.name >> p2.name;
            prikazprvog = true;
            tekstPrvi.setString("Prvi igra: " + ((currentplayer == 1) ? p1.name : p2.name));
            prvi.restart();
        }
        else if (gumbRacunalo.getGlobalBounds().contains(mis.x, mis.y)) {
            stanjeIgre = JedanIgrac;
            cin >> p1.name;
            p2.name = "BOT";
            prikazprvog = true;
            tekstPrvi.setString("Prvi igra: " + ((currentplayer == 1) ? p1.name : p2.name));
            prvi.restart();
        }
    }

    void handleclick(int x) {
        if ((stanjeIgre == izbornik || stanjeIgre == Menu) || igragotova || pada) return;

        stupac = x / CELL_WIDTH;
        if (stupac >= 0 && stupac < 7 && !board.jelipun(stupac)) {
            board.pronadired(stupac, red);
            pada = true;
            animstupac = stupac;
            animred = red;
            animigrac = currentplayer;
            animY = 0;
        }
    }

    void update() {
        if (prikazprvog) {
            if (prvi.getElapsedTime().asSeconds() > 5.0f)
                prikazprvog = false;
            else return;
        }

        if (stanjeIgre == JedanIgrac && currentplayer == 2 && !pada && !igragotova) {
            int s = odaberiNajboljiStupacAI(); // NOVO-----------------------------------------------------------------------
            handleclick(s * CELL_WIDTH);
        }

        if (!pada) return;

        float ciljaniY = animred * CELL_HEIGHT + PADDING;
        if (animY < ciljaniY) animY += brzina;
        else {
            board.postavizeton(animred, animstupac, animigrac);
            pada = false;

            if (board.provjerapobjede(animigrac, animstupac, animred)) {
                igragotova = true;
                pobjednik = animigrac;
                tekstPobjede.setString((pobjednik == 1 ? p1.name : p2.name) + " JE POBIJEDIO");
            }
            else currentplayer = (currentplayer == 1 ? 2 : 1);
        }
    }

    void resetGame() {
        board.reset();
        igragotova = false;
        pada = false;
        prikazprvog = false;
        currentplayer = rand() % 2 + 1;
    }

    void draw(RenderWindow& w) {
        if (stanjeIgre == izbornik) {
            w.draw(naslov);
            w.draw(gumbDvaIgraca);
            w.draw(gumbRacunalo);
            w.draw(tekstDvaIgraca);
            w.draw(tekstRacunalo);
            return;
        }

        if (prikazprvog) {
            w.draw(tekstPrvi);
            return;
        }

        if (!igragotova) board.draw(w);
        else {
            w.draw(tekstPobjede);
            w.draw(gumbRestart);
            w.draw(gumbExit);
            w.draw(tekstRestart);
            w.draw(tekstExit);
        }

        if (pada) {
            CircleShape c(45.f);
            c.setPosition(animstupac * CELL_WIDTH + PADDING, animY);
            c.setFillColor(animigrac == 1 ? Color::Yellow : Color::Red);
            w.draw(c);
        }
    }
};

int main() {
    RenderWindow window(VideoMode(800, 700), "Connect Four");
    window.setFramerateLimit(60);

    Game game;

    while (window.isOpen()) {
        Event event;
        while (window.pollEvent(event)) {
            if (event.type == Event::Closed) window.close();
            if (event.type == Event::MouseButtonPressed && event.mouseButton.button == Mouse::Left) {
                Vector2i mis = Mouse::getPosition(window);

                if (game.jeIzbornik())
                    game.obradiKlikIzbornika(mis);
                else if (game.jeIgraGotova())
                    game.obradiKlikEnd(mis);
                else
                    game.handleclick(event.mouseButton.x);
            }
        }

        if (game.getStanje() == Restart) {
            game.resetGame();
            game.setStanje(izbornik);
        }

        if (game.getStanje() == Exit)
            window.close();

        game.update();

        window.clear(Color::Black);
        game.draw(window);
        window.display();
    }
    return 0;
}
